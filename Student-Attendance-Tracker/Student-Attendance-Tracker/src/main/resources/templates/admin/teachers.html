<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Manage Teachers</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</head>
<body>

<nav class="navbar navbar-dark bg-dark px-3">
    <a class="navbar-brand fw-semibold" href="#">Attendance Tracker</a>
    <div class="ms-auto d-flex gap-3 align-items-center">
        <span class="text-light small">Welcome, <span sec:authentication="name"></span></span>
        <form th:action="@{/logout}" method="post" class="mb-0">
            <button type="submit" class="btn btn-outline-light btn-sm">
                <i class="bi bi-box-arrow-right me-1"></i>Logout
            </button>
        </form>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">

        <!-- Sidebar -->
        <div class="col-md-2 bg-light min-vh-100 pt-3 border-end">
            <ul class="nav flex-column gap-1">
                <li><a href="/admin/dashboard" class="nav-link text-dark"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a></li>
                <li><a href="/admin/teachers" class="nav-link text-dark fw-semibold"><i class="bi bi-person-workspace me-2"></i>Teachers</a></li>
                <li><a href="/admin/students" class="nav-link text-dark"><i class="bi bi-people me-2"></i>Students</a></li>
                <li><a href="/admin/reports" class="nav-link text-dark"><i class="bi bi-bar-chart me-2"></i>Reports</a></li>
            </ul>
        </div>

        <!-- Content -->
        <div class="col-md-10 p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Manage Teachers</h5>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addModal">
                    <i class="bi bi-plus-lg"></i> Add Teacher
                </button>
            </div>

            <div class="table-responsive">
                <table class="table table-hover table-bordered align-middle">
                    <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>Full Name</th>
                        <th>Username</th>
                        <th>Assigned Students</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="t, stat : ${teachers}">
                        <td th:text="${stat.count}"></td>
                        <td th:text="${t.fullName}"></td>
                        <td th:text="${t.username}"></td>
                        <td>
                            <span th:if="${t.assignedStudents != null and !t.assignedStudents.empty}"
                                  class="badge bg-info text-dark"
                                  th:text="${t.assignedStudents.size()} + ' student(s)'"></span>
                            <span th:if="${t.assignedStudents == null or t.assignedStudents.empty}"
                                  class="text-muted small">None</span>
                        </td>
                        <td>
                            <div class="d-flex gap-1 flex-wrap">
                                <!--
                                    FIX: data-* attributes instead of th:onclick.
                                    Previously:  th:onclick="|openEdit(${t.id}, '${t.fullName}', '${t.username}')|"
                                    Bug: if fullName contained an apostrophe (e.g. "O'Brien"), Thymeleaf
                                    rendered:  openEdit(1, 'O'Brien', ...)  — broken JavaScript.
                                    data-* attributes are HTML-escaped by Thymeleaf, so always safe.
                                -->
                                <button class="btn btn-sm btn-outline-warning edit-teacher-btn"
                                        data-bs-toggle="modal"
                                        data-bs-target="#editModal"
                                        th:data-id="${t.id}"
                                        th:data-fullname="${t.fullName}"
                                        th:data-username="${t.username}">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-outline-info assign-btn"
                                        data-bs-toggle="modal"
                                        data-bs-target="#assignModal"
                                        th:data-id="${t.id}">
                                    <i class="bi bi-person-plus"></i> Assign
                                </button>
                                <a th:href="@{/admin/teachers/delete/{id}(id=${t.id})}"
                                   class="btn btn-sm btn-outline-danger"
                                   onclick="return confirm('Delete this teacher? Their student assignments will also be removed.')">
                                    <i class="bi bi-trash"></i> Delete
                                </a>
                            </div>
                        </td>
                    </tr>
                    <tr th:if="${teachers.empty}">
                        <td colspan="5" class="text-center text-muted py-3">No teachers added yet.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Teacher Modal -->
<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Teacher</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/admin/teachers/add" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input type="text" name="fullName" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" name="username" class="form-control" required autocomplete="off">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" name="password" class="form-control" required autocomplete="new-password">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Teacher</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Teacher Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Teacher</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editForm" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input type="text" id="editFullName" name="fullName" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" id="editUsername" name="username" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">New Password <small class="text-muted">(leave blank to keep current)</small></label>
                        <input type="password" name="password" class="form-control" autocomplete="new-password">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Update Teacher</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Assign Students Modal -->
<div class="modal fade" id="assignModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Students to Teacher</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="assignForm" method="post">
                <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                    <p class="text-muted small mb-2">
                        Select students to assign. Previously assigned students are pre-checked.
                    </p>

                    <!-- Spinner shown while fetching current assignments via fetch() -->
                    <div id="assignLoading" class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        <span class="ms-2 small text-muted">Loading assignments...</span>
                    </div>

                    <div id="assignCheckboxes" style="display:none;">
                        <div th:each="s : ${allStudents}" class="form-check border-bottom py-1">
                            <input class="form-check-input assign-checkbox" type="checkbox"
                                   name="studentIds"
                                   th:value="${s.id}"
                                   th:id="'chk_' + ${s.id}">
                            <label class="form-check-label"
                                   th:for="'chk_' + ${s.id}"
                                   th:text="${s.fullName} + ' | Roll: ' + ${s.rollNumber} + ' | Class: ' + ${s.className}">
                            </label>
                        </div>
                        <p th:if="${allStudents.empty}" class="text-muted text-center">
                            No students available. Please add students first.
                        </p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-info text-white">Save Assignments</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ── Edit Teacher modal ───────────────────────────────────────────────────
    // Reads teacher data from data-* attributes — safe for any characters.
    document.getElementById('editModal').addEventListener('show.bs.modal', function (event) {
        const btn = event.relatedTarget;
        document.getElementById('editFullName').value = btn.getAttribute('data-fullname') || '';
        document.getElementById('editUsername').value = btn.getAttribute('data-username')  || '';
        document.getElementById('editForm').action = '/admin/teachers/edit/' + btn.getAttribute('data-id');
    });

    // ── Assign Students modal ────────────────────────────────────────────────
    // When the modal opens, fetches the teacher's current assignments from the
    // server and pre-checks the matching checkboxes automatically.
    document.getElementById('assignModal').addEventListener('show.bs.modal', async function (event) {
        const teacherId = event.relatedTarget.getAttribute('data-id');
        document.getElementById('assignForm').action = '/admin/teachers/assign/' + teacherId;

        // Reset state
        document.getElementById('assignLoading').style.display  = 'block';
        document.getElementById('assignCheckboxes').style.display = 'none';
        document.querySelectorAll('.assign-checkbox').forEach(cb => cb.checked = false);

        try {
            const res = await fetch('/admin/teachers/' + teacherId + '/assigned');
            const assignedIds = await res.json();   // array of student IDs already assigned
            assignedIds.forEach(sid => {
                const cb = document.querySelector('.assign-checkbox[value="' + sid + '"]');
                if (cb) cb.checked = true;
            });
        } catch (err) {
            console.error('Could not load assignments:', err);
        }

        document.getElementById('assignLoading').style.display  = 'none';
        document.getElementById('assignCheckboxes').style.display = 'block';
    });
</script>
</body>
</html>